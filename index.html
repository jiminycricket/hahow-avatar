<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Hello!</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    
    <!-- import the webpage's stylesheet -->
    <link rel="stylesheet" href="/style.css">
    
    <!-- import the webpage's javascript file -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.6/dist/jquery.fancybox.min.css" />
    <script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.6/dist/jquery.fancybox.min.js"></script>
    <script src="/init.js"></script>
  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-6421801-12"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ismobilejs/0.4.1/isMobile.js"></script>

    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-6421801-12');
    </script>
  </head>  
  <body>
    <h1 class="loading">Loading</h1>
    <div style="display: none;" id="modal">
      <h2>你願意花多少 HP 購買!</h2>
      <p class="btn text-center">100 HP</p>
      <p class="btn text-center">200 HP</p>
      <p class="btn text-center">400 HP</p>
      <p class="btn text-center">1,000 HP</p>
    </div>
    <div class="main">
      <div class="canvas-container">
        <div class="canvas">
        </div>
      </div>

      <div class="controller-panel">
        <div class="mobile-tip">
          請往下滑更換服裝
        </div>
      </div>      
    </div>
    <div class="download-btn" style="display: none" onclick="downloadImage()">
      <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAP0SURBVGhD7drZy01RGMfxIxKS6U9wRZLpwp2kKEXGG5QxMxERZbwwDykpiSLJVDIkknkWN4YSCVEiJPM8fH8n+22/633OOfvs4XROrac+N+fs/az1nL332mut98358OHDhw8fPnz4qOFoi2HYhMt4ga/4hEf/P1uPfmiGmo3+OIJv+BvRZxxGL9RMdMEVWAWV4yI6oapjDr7DKiCOL5iKqotG2Ayr02nYgKoJFbsDVkcDT7AT8zAaQzEcEzEfu/AM1rmBtaiKWAWrg6JCl2NABAOxEjrHyiXKVfFogp7Qq+YsrI79xl4MhlVcMUOgkfoP3Lz6rC8yjzYYhQN4D7cjYT+xAlYx5dCd8wtuft36rZFJNMdCvIPbcCGaYFgFxLEFVhuLkHp0x1NYDRZyFVbH49JzfQtuOy+hi5FaaATVrMdtqBgdrxHY6ngSY2G928cglRgH69kJ00iq2dRRaPp4COtgdThsLvR6ClsA69iwk7D6oaJ7owViRR/8gJVcP8JxTIDVqShUoJv3IKxjw2bBPS9MixH1bRJaIlK0x1tYCW9DkwSrM+WIW7Ce5Q9wz7VoNabCNSEqGsdgJTiBQbA6Uq64Bct1uOcWsw8FBzYtx6yTLkG/rtWBOJIUvB/uuaVord0KDcK6uhr6NZuyGo8rScFr8Bw3oedVA+Vp3Ic1KwucQmPUhR5yLcPcA7ULYTWcRJKCi9H4cgGFCt+IutDc1T1Ar500b+VAVgUHFuMj3DY0t++MfGyFe4A6ZiVMKuuCRe96a1tJc4Z8XIP7pdatVrKkKlGwbIfbjuYX7WCuP8fDShSFBhcVZrHmxXdgHSvKZbVRipaleh+7bY2Eefn1XFuJotCP9QpuznIpR5IffhvcnLuRexP6IDACVpKokhadtFiZCTevZoy5e6EPAtNgJSlH3KLTKFZ0+7q5XyP/Ene/0N6SlaRc5RadVrFivW71+OZ3Dd0vzsBKEkfUotMsVrSqc9t4jFzH0AcBLbjTbLxU0WkXK0vhtnMO+XgI98s0r7IUKjqLYsXaUV2GfCyB+6XmpfrcShaXW3RWxc6AppPheqQH8qEllPXr60+aaYzYYUHRWRWrSYf15tH2br1NgSlwDxIVncWVzqpYLRmtOmajXqj6PbAO1u2tZ0IbfFZD1WA6rCsr+sN7UzQI7f4V20rRBFyFr4Ya0MvdarwS9J7VXaLRWH0qtBbW9nFXFAz9WeUGrJNrjXZatR9XMvS/FoVu71qhsUd3QeTQMz0Z1uhd7TSv6IZYoT0vjdIPYCWvJnr1aDQ2B6g40QHaDdF2yV1o9WE1XAlaCGjz4jw0cGlSUXLz3YcPHz58+PDhw0c2kcv9A0rVhrgd33D5AAAAAElFTkSuQmCC">
    </div>
      
    <canvas id="canvas" class="hidden" width="802" height="937"></canvas>
    <script>
      var assets = {};
      var controllerItemWidth = 100;
      preloadAssets();
      //preload image assets and prepare controllers
      function preloadAssets(){
        var checkpoints = 0;
        for(var key in config){
          // preload images
          var assetsArray = config[key].images;
          var layout = $('<div class="layout">');
          layout.addClass('layout-' + key);
          $('.canvas').append(layout);
          for(var i = 0; i< assetsArray.length; i++){
            checkpoints +=1;
            var thumbnail = new Image();
            var image = new Image();
            if(!assets[key]){
              assets[key] = [];
            }
            assets[key].push({
              'thumbnail': thumbnail,
              'image': image
            });
            $(thumbnail).data('src-dom', assetsArray[i].src ? image : null);
            thumbnail.load(assetsArray[i].thumbnail, function(e){
              checkpoints -=1;
              // preload finish
              if(checkpoints===0){
                preloadFinishCallback();
              }
            })
            image.load(assetsArray[i].src, function(e){
              checkpoints -=1;
              // preload finish
              if(checkpoints===0){
                preloadFinishCallback();
              }
            })
          }
        }
      }
      
      function preloadFinishCallback(){
        $('.loading').hide();
        $('.download-btn').show();
        //append child
        for(var key in assets) {
          var container = $('<div class="controller-container">');
          var ul = $('<ul class="controller">');
          ul.addClass('controller-' + key);
          container.append(ul);
          var itemConfig = config[key];
          for(var i = 0; i<assets[key].length;i++){
            var li = $('<li>');
            li.data('layout', key);
            li.append(assets[key][i].thumbnail);
            
            if($(assets[key][i].thumbnail).data('src-dom') === null){
              li.addClass('pay-content');
              li.attr('data-fancybox','');
              li.attr('data-src','#modal');
            }
            li.on('click', appendToCanvas);
            ul.append(li);
            
            if(itemConfig.required && itemConfig.defaultIndex === undefined && i === 0){
                li.click();
            } else if(itemConfig.defaultIndex === i) {
                li.click();
            }
          }
          var width=(controllerItemWidth+15)*assets[key].length
          ul.css('width', width + 'px');
          $('.controller-panel').append(container);
        }
      }
      
      function appendToCanvas(e){
        var li = $(e.currentTarget);
        var layoutType = li.data('layout');
        
        if(li.hasClass('selected')){
          
          if(config[layoutType].required){
            alert('請不要脫我衣服！')
            return;
          }
          var children = li.parent().children();
          children.removeClass('selected');
          $('.layout-' + layoutType).html('');
        } else {
          var thumbnail = li.find('img');
          if(thumbnail.data('src-dom')===null){
            return;
          }
          var children = li.parent().children();
          children.removeClass('selected');
          li.addClass('selected');
          $('.layout-' + layoutType).html(thumbnail.data('src-dom'));
        }
      }
      function downloadImage(){

        var canvas = document.getElementById('canvas');
        var ctx = canvas.getContext('2d');
        ctx.globalAlpha = 1;
        for(var key in config){
          if($('.layout-'+key+' img')[0] !== undefined){
            ctx.drawImage($('.layout-' + key + ' img')[0],0,0);
          }
        }
        var image
        if(isMobile.apple.device){
          $.fancybox.open('<div class="message"><h2>Hello!</h2><p>小蛙著裝中… 請在圖片產生後，長按即可儲存圖片囉～</p></div>');
          setTimeout(function(){
            image = canvas.toDataURL("image/png");
            window.open(image)
            $.fancybox.close();
          }, 4500);
        } else {
          var link = document.createElement('a')
          image = canvas.toDataURL("image/png").replace("image/png", "image/octet-stream");
          link.setAttribute("href", image);
          link.setAttribute("download", "profile.png");
          if(isMobile.android.device) {
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            $.fancybox.open('<div class="message"><h2>Hello!</h2><p>下載完成</p></div>');
            setTimeout(function(){
              $.fancybox.close();
            }, 2000)
          } else {
            link.click();
          }
        }
        
        if(gtag){
          gtag('event', '下載', {
            'event_category': '全身圖下載',
            'event_label': '',
            'value': 1
          });
        }
      }
    </script>
  </body>
</html>
