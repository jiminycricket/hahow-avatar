<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Hello!</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- import the webpage's stylesheet -->
    <link rel="stylesheet" href="/style.css">
    
    <!-- import the webpage's javascript file -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.6/dist/jquery.fancybox.min.css" />
    <script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.6/dist/jquery.fancybox.min.js"></script>
    <script src="/init.js"></script>
    <style>
      .controller-panel ul, .controller li {
        padding: 0;
        list-style: none;
        overflow: hidden;
      }
      .controller-panel {
        border-left: 1px solid #cdcdcd;
      }
      .controller-panel ul li img {
        width: 100px;
        display: block;
      }
      .controller-panel ul li {
        border: 1px solid #cdcdcd;
        border-radius: 4px;
        margin-left: 10px;
        cursor: pointer;
        display: inline-block;
        position: relative;
      }
      .controller-panel ul li.selected {
        border-color: #fa8b00;
        
      }
      .controller-panel .controller-container {
        width: 300px;
        overflow-x: auto;
      }
      .canvas {
        width: 802px;
        height: 937px;
      }
      .main {
        display: flex;
      }
      .layout {
        position: absolute;
      }
      .hidden {
        display: none;
      }
      .download-btn {
        position: absolute;
        top: 20px;
      }
      .btn {
        cursor: pointer;
      }
      .text-center {
        text-align: center;
      }
      .pay-content::after {
        content: url('data:image/png;base64,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');
        display: block;
        width: 38px;
        position: absolute;
        top: 3px;
        right: 4px;
      }
      #modal p {
        background: #fa8b00;
        color: white;
        border-radius: 20px;
        height: 40px;
        line-height: 40px;
      }
    </style>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-6421801-12"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-6421801-12');
    </script>
  </head>  
  <body>
    <h1 class="loading">Loading</h1>
    <div style="display: none;" id="modal">
      <h2>你願意花多少 HP 購買!</h2>
      <p class="btn text-center">100 HP</p>
      <p class="btn text-center">200 HP</p>
      <p class="btn text-center">400 HP</p>
      <p class="btn text-center">1,000 HP</p>
    </div>
    <div class="main">
      <div class="canvas">
      </div>
      <div class="controller-panel">
      </div>      
    </div>
    <div class="download-btn" onclick="downloadImage()">
      <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAP0SURBVGhD7drZy01RGMfxIxKS6U9wRZLpwp2kKEXGG5QxMxERZbwwDykpiSLJVDIkknkWN4YSCVEiJPM8fH8n+22/633OOfvs4XROrac+N+fs/az1nL332mut98358OHDhw8fPnz4qOFoi2HYhMt4ga/4hEf/P1uPfmiGmo3+OIJv+BvRZxxGL9RMdMEVWAWV4yI6oapjDr7DKiCOL5iKqotG2Ayr02nYgKoJFbsDVkcDT7AT8zAaQzEcEzEfu/AM1rmBtaiKWAWrg6JCl2NABAOxEjrHyiXKVfFogp7Qq+YsrI79xl4MhlVcMUOgkfoP3Lz6rC8yjzYYhQN4D7cjYT+xAlYx5dCd8wtuft36rZFJNMdCvIPbcCGaYFgFxLEFVhuLkHp0x1NYDRZyFVbH49JzfQtuOy+hi5FaaATVrMdtqBgdrxHY6ngSY2G928cglRgH69kJ00iq2dRRaPp4COtgdThsLvR6ClsA69iwk7D6oaJ7owViRR/8gJVcP8JxTIDVqShUoJv3IKxjw2bBPS9MixH1bRJaIlK0x1tYCW9DkwSrM+WIW7Ce5Q9wz7VoNabCNSEqGsdgJTiBQbA6Uq64Bct1uOcWsw8FBzYtx6yTLkG/rtWBOJIUvB/uuaVord0KDcK6uhr6NZuyGo8rScFr8Bw3oedVA+Vp3Ic1KwucQmPUhR5yLcPcA7ULYTWcRJKCi9H4cgGFCt+IutDc1T1Ar500b+VAVgUHFuMj3DY0t++MfGyFe4A6ZiVMKuuCRe96a1tJc4Z8XIP7pdatVrKkKlGwbIfbjuYX7WCuP8fDShSFBhcVZrHmxXdgHSvKZbVRipaleh+7bY2Eefn1XFuJotCP9QpuznIpR5IffhvcnLuRexP6IDACVpKokhadtFiZCTevZoy5e6EPAtNgJSlH3KLTKFZ0+7q5XyP/Ene/0N6SlaRc5RadVrFivW71+OZ3Dd0vzsBKEkfUotMsVrSqc9t4jFzH0AcBLbjTbLxU0WkXK0vhtnMO+XgI98s0r7IUKjqLYsXaUV2GfCyB+6XmpfrcShaXW3RWxc6AppPheqQH8qEllPXr60+aaYzYYUHRWRWrSYf15tH2br1NgSlwDxIVncWVzqpYLRmtOmajXqj6PbAO1u2tZ0IbfFZD1WA6rCsr+sN7UzQI7f4V20rRBFyFr4Ya0MvdarwS9J7VXaLRWH0qtBbW9nFXFAz9WeUGrJNrjXZatR9XMvS/FoVu71qhsUd3QeTQMz0Z1uhd7TSv6IZYoT0vjdIPYCWvJnr1aDQ2B6g40QHaDdF2yV1o9WE1XAlaCGjz4jw0cGlSUXLz3YcPHz58+PDhw0c2kcv9A0rVhrgd33D5AAAAAElFTkSuQmCC">
    </div>
      
    <canvas id="canvas" class="hidden" width="802" height="937"></canvas>
    <script>
      var assets = {};
      var controllerItemWidth = 100;
      preloadAssets();
      //preload image assets and prepare controllers
      function preloadAssets(){
        var checkpoints = 0;
        for(var key in config){
          // preload images
          var assetsArray = config[key].images;
          var layout = $('<div class="layout">');
          layout.addClass('layout-' + key);
          $('.canvas').append(layout);
          for(var i = 0; i< assetsArray.length; i++){
            checkpoints +=1;
            var thumbnail = new Image();
            var image = new Image();
            if(!assets[key]){
              assets[key] = [];
            }
            assets[key].push({
              'thumbnail': thumbnail,
              'image': image
            });
            $(thumbnail).data('src-dom', assetsArray[i].src ? image : null);
            thumbnail.load(assetsArray[i].thumbnail, function(e){
              checkpoints -=1;
              // preload finish
              if(checkpoints===0){
                preloadFinishCallback();
              }
            })
            image.load(assetsArray[i].src, function(e){
              checkpoints -=1;
              // preload finish
              if(checkpoints===0){
                preloadFinishCallback();
              }
            })
          }
        }
      }
      
      function preloadFinishCallback(){
        $('.loading').hide();
        //append child
        for(var key in assets) {
          var container = $('<div class="controller-container">');
          var ul = $('<ul class="controller">');
          ul.addClass('controller-' + key);
          container.append(ul);
          var itemConfig = config[key];
          for(var i = 0; i<assets[key].length;i++){
            var li = $('<li>');
            li.data('layout', key);
            li.append(assets[key][i].thumbnail);
            
            if($(assets[key][i].thumbnail).data('src-dom') === null){
              li.addClass('pay-content');
              li.attr('data-fancybox','');
              li.attr('data-src','#modal');
            }
            li.on('click', appendToCanvas);
            ul.append(li);
            
            if(itemConfig.required && itemConfig.defaultIndex === undefined && i === 0){
                li.click();
            } else if(itemConfig.defaultIndex === i) {
                li.click();
            }
          }
          var width=(controllerItemWidth+15)*assets[key].length
          ul.css('width', width + 'px');
          $('.controller-panel').append(container);
        }
      }
      
      function appendToCanvas(e){
        var li = $(e.currentTarget);
        var layoutType = li.data('layout');
        
        if(li.hasClass('selected')){
          
          if(config[layoutType].required){
            alert('請不要脫我衣服！')
            return;
          }
          var children = li.parent().children();
          children.removeClass('selected');
          $('.layout-' + layoutType).html('');
        } else {
          var thumbnail = li.find('img');
          if(thumbnail.data('src-dom')===null){
            return;
          }
          var children = li.parent().children();
          children.removeClass('selected');
          li.addClass('selected');
          $('.layout-' + layoutType).html(thumbnail.data('src-dom'));
        }
      }
      function downloadImage(){

        var canvas = document.getElementById('canvas');
        var ctx = canvas.getContext('2d');
        ctx.globalAlpha = 1;
        for(var key in config){
          if($('.layout-'+key+' img')[0] !== undefined){
            ctx.drawImage($('.layout-' + key + ' img')[0],0,0);
          }
        }
        var link = document.createElement('a')
        var image = canvas.toDataURL("image/png").replace("image/png", "image/octet-stream");
        link.setAttribute("href", image);
        link.setAttribute("download", "profile.png")
        link.click();
        if(gtag){
          gtag('event', '下載', {
            'event_category': '全身圖下載',
            'event_label': '',
            'value': 1
          });
        }
      }
    </script>
  </body>
</html>
